<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vibe-Check Developer Dashboard</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            min-height: 100vh;
        }

        .dashboard-container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .view-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .view-btn {
            padding: 10px 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .view-btn.active {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.6);
        }

        .view-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .dashboard-section {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .section-title {
            font-size: 1.5rem;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Map View Styles */
        .map-container {
            height: 600px;
            border-radius: 10px;
            overflow: hidden;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }

        #map {
            height: 100%;
            width: 100%;
        }

        .map-legend {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.8);
            padding: 10px;
            border-radius: 8px;
            z-index: 1000;
        }

        /* Camera Grid Styles */
        .camera-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
            max-height: 600px;
            overflow-y: auto;
        }

        .camera-card {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 10px;
            padding: 15px;
            border-left: 5px solid;
            transition: transform 0.2s ease;
        }

        .camera-card:hover {
            transform: translateY(-2px);
            background: rgba(255, 255, 255, 0.2);
        }

        .camera-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .camera-name {
            font-weight: bold;
            font-size: 1.1rem;
        }

        .frequency-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: bold;
            color: black;
        }

        .camera-image {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 10px;
            background: rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.9rem;
        }

        .camera-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 8px;
        }

        .camera-details {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-bottom: 10px;
        }

        .camera-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .frequency-input {
            width: 60px;
            padding: 5px;
            border: none;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.9);
            color: black;
        }

        .btn {
            padding: 5px 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: background-color 0.2s ease;
        }

        .btn-update {
            background: #28a745;
            color: white;
        }

        .btn-update:hover {
            background: #218838;
        }

        .btn-reset {
            background: #6c757d;
            color: white;
        }

        .btn-reset:hover {
            background: #5a6268;
        }

        .frequency-legend {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-item {
            text-align: center;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #ffd700;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .refresh-btn {
            background: #17a2b8;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            margin-bottom: 20px;
        }

        .refresh-btn:hover {
            background: #138496;
        }

        .loading {
            text-align: center;
            padding: 20px;
            font-size: 1.2rem;
        }

        .error {
            background: rgba(220, 53, 69, 0.2);
            border: 1px solid #dc3545;
            color: #dc3545;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .system-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .view-section {
            display: none;
        }

        .view-section.active {
            display: block;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            .camera-grid {
                grid-template-columns: 1fr;
            }

            .view-controls {
                flex-direction: column;
                align-items: center;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <div class="header">
            <h1>üéõÔ∏è Vibe-Check Developer Dashboard</h1>
            <div class="subtitle">Adaptive Camera Monitoring System Control Panel</div>
        </div>

        <div class="view-controls">
            <button class="view-btn active" onclick="switchView('camera-list')" id="camera-list-btn">
                üìπ Camera List View
            </button>
            <button class="view-btn" onclick="switchView('map-view')" id="map-view-btn">
                üó∫Ô∏è Map Heatmap View
            </button>
            <button class="refresh-btn" onclick="loadDashboardData()">
                üîÑ Refresh Data
            </button>
        </div>

        <div id="loading" class="loading">
            Loading dashboard data...
        </div>

        <div id="error" class="error" style="display: none;"></div>

        <div id="dashboard-content" style="display: none;">
            <div class="system-info">
                <div id="last-updated"></div>
                <div id="system-status"></div>
            </div>

            <!-- Camera List View -->
            <div id="camera-list-view" class="view-section active">
                <div class="dashboard-grid">
                    <!-- Frequency Distribution -->
                    <div class="dashboard-section">
                        <div class="section-title">
                            üìä Sampling Frequency Distribution
                        </div>
                        
                        <div class="frequency-legend" id="frequency-legend"></div>
                        
                        <div class="stats-grid" id="frequency-stats"></div>
                    </div>

                    <!-- System Overview -->
                    <div class="dashboard-section">
                        <div class="section-title">
                            üóΩ System Overview
                        </div>
                        
                        <div class="stats-grid" id="system-stats"></div>
                    </div>
                </div>

                <!-- Camera Zones -->
                <div class="dashboard-section">
                    <div class="section-title">
                        üìπ Camera Zones & Manual Controls
                    </div>
                    
                    <div class="camera-grid" id="camera-grid"></div>
                </div>
            </div>

            <!-- Map View -->
            <div id="map-view" class="view-section">
                <div class="dashboard-section">
                    <div class="section-title">
                        üó∫Ô∏è Geographic Zone Heatmap
                    </div>
                    
                    <div class="map-container">
                        <div id="map"></div>
                        <div class="map-legend" id="map-legend"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        const API_BASE = 'https://us-central1-vibe-check-463816.cloudfunctions.net/api';
        let dashboardData = null;
        let mapData = null;
        let map = null;
        let currentView = 'camera-list';

        // Load dashboard data on page load
        window.addEventListener('load', loadDashboardData);

        async function loadDashboardData() {
            try {
                document.getElementById('loading').style.display = 'block';
                document.getElementById('error').style.display = 'none';
                document.getElementById('dashboard-content').style.display = 'none';

                // Load both camera data and map data
                const [cameraResponse, mapResponse] = await Promise.all([
                    fetch(`${API_BASE}/dashboard/camera-zones`),
                    fetch(`${API_BASE}/dashboard/map-zones`)
                ]);

                const cameraData = await cameraResponse.json();
                const mapDataResponse = await mapResponse.json();

                if (!cameraData.success || !mapDataResponse.success) {
                    throw new Error(cameraData.error || mapDataResponse.error || 'Failed to load dashboard data');
                }

                dashboardData = cameraData.dashboard_data;
                mapData = mapDataResponse.map_data;
                
                renderDashboard();

            } catch (error) {
                console.error('Dashboard loading error:', error);
                document.getElementById('error').textContent = `Error: ${error.message}`;
                document.getElementById('error').style.display = 'block';
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        function switchView(viewName) {
            currentView = viewName;
            
            // Update buttons
            document.querySelectorAll('.view-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`${viewName}-btn`).classList.add('active');
            
            // Update views
            document.querySelectorAll('.view-section').forEach(section => section.classList.remove('active'));
            document.getElementById(`${viewName}-view`).classList.add('active');
            
            if (viewName === 'map-view' && mapData && !map) {
                initializeMap();
            }
        }

        function renderDashboard() {
            document.getElementById('dashboard-content').style.display = 'block';
            
            // Update system info
            document.getElementById('last-updated').textContent = 
                `Last Updated: ${new Date().toLocaleTimeString()}`;
            document.getElementById('system-status').textContent = 
                `${dashboardData.total_cameras} cameras active`;

            // Render camera list view
            renderFrequencyDistribution();
            renderSystemOverview();
            renderCameraZones();
        }

        function renderFrequencyDistribution() {
            const legendContainer = document.getElementById('frequency-legend');
            const statsContainer = document.getElementById('frequency-stats');

            // Frequency legend
            legendContainer.innerHTML = '';
            Object.entries(dashboardData.frequency_breakpoints).forEach(([tier, info]) => {
                const legendItem = document.createElement('div');
                legendItem.className = 'legend-item';
                legendItem.innerHTML = `
                    <div class="legend-color" style="background-color: ${info.color}"></div>
                    <div>
                        <div style="font-weight: bold;">${tier.replace('_', ' ')}</div>
                        <div style="font-size: 0.8rem;">${info.range}</div>
                    </div>
                `;
                legendContainer.appendChild(legendItem);
            });

            // Frequency stats
            statsContainer.innerHTML = '';
            Object.entries(dashboardData.frequency_breakpoints).forEach(([tier, info]) => {
                const statItem = document.createElement('div');
                statItem.className = 'stat-item';
                statItem.innerHTML = `
                    <div class="stat-number">${info.count}</div>
                    <div class="stat-label">${tier.replace('_', ' ')}</div>
                `;
                statsContainer.appendChild(statItem);
            });
        }

        function renderSystemOverview() {
            const container = document.getElementById('system-stats');
            
            const stats = [
                { label: 'Total Cameras', value: dashboardData.total_cameras },
                { label: 'Enhanced System', value: dashboardData.enhanced_cameras },
                { label: 'Original System', value: dashboardData.original_cameras },
                { label: 'High Risk Zones', value: dashboardData.high_risk_zones.length },
                { label: 'Baseline Cameras', value: dashboardData.baseline_cameras.length },
                { label: 'Avg Frequency', value: `${dashboardData.sampling_range.avg_hours.toFixed(1)}h` }
            ];

            container.innerHTML = '';
            stats.forEach(stat => {
                const statItem = document.createElement('div');
                statItem.className = 'stat-item';
                statItem.innerHTML = `
                    <div class="stat-number">${stat.value}</div>
                    <div class="stat-label">${stat.label}</div>
                `;
                container.appendChild(statItem);
            });
        }

        function renderCameraZones() {
            const container = document.getElementById('camera-grid');
            container.innerHTML = '';

            dashboardData.camera_zones
                .sort((a, b) => a.sampling_frequency_hours - b.sampling_frequency_hours)
                .forEach(camera => {
                    const cameraCard = document.createElement('div');
                    cameraCard.className = 'camera-card';
                    cameraCard.style.borderLeftColor = camera.frequency_color;

                    const stats = camera.analysis_stats || {};
                    const lastAnalyzed = stats.last_analysis_ago || 'Never';
                    const todayCount = stats.today_analyses || 0;
                    const totalCount = stats.total_analyses || 0;

                    cameraCard.innerHTML = `
                        <div class="camera-header">
                            <div class="camera-name">${camera.camera_name}</div>
                            <div class="frequency-badge" style="background-color: ${camera.frequency_color};">
                                ${camera.sampling_frequency_hours.toFixed(1)}h
                            </div>
                        </div>
                        
                        <div class="camera-image" id="image-${camera.camera_id}">
                            Loading camera feed...
                        </div>
                        
                        <div class="camera-details">
                            üìç ${camera.neighborhood} ‚Ä¢ ${camera.frequency_tier.replace('_', ' ')}
                            ${camera.is_high_risk_zone ? ' ‚Ä¢ üö® High Risk' : ''}
                            ${camera.is_baseline_camera ? ' ‚Ä¢ üìä Baseline' : ''}
                            ${camera.manual_override ? ' ‚Ä¢ ‚úã Manual Override' : ''}
                        </div>

                        <div class="analysis-stats" style="font-size: 0.8rem; opacity: 0.9; margin-bottom: 10px; background: rgba(255,255,255,0.1); padding: 8px; border-radius: 5px;">
                            <div><strong>üìä Analysis Stats:</strong></div>
                            <div>Last analyzed: <strong>${lastAnalyzed}</strong></div>
                            <div>Today: <strong>${todayCount}</strong> ‚Ä¢ Total: <strong>${totalCount}</strong></div>
                            ${stats.avg_analyses_per_day ? `<div>Avg/day: <strong>${stats.avg_analyses_per_day}</strong></div>` : ''}
                        </div>

                        <div class="camera-controls">
                            <input type="number" 
                                   class="frequency-input" 
                                   id="freq-${camera.camera_id}"
                                   value="${camera.sampling_frequency_hours.toFixed(1)}"
                                   min="0.5" 
                                   max="96" 
                                   step="0.5">
                            <span style="font-size: 0.8rem;">hours</span>
                            
                            <button class="btn btn-update" 
                                    onclick="updateCameraFrequency('${camera.camera_id}')">
                                Update
                            </button>
                            
                            <button class="btn btn-reset" 
                                    onclick="resetCameraToAdaptive('${camera.camera_id}')">
                                Reset
                            </button>
                        </div>
                    `;

                    container.appendChild(cameraCard);
                    
                    // Load camera image
                    loadCameraImage(camera.camera_id);
                });
        }

        async function loadCameraImage(cameraId) {
            try {
                const imageContainer = document.getElementById(`image-${cameraId}`);
                
                const img = document.createElement('img');
                img.onload = () => {
                    imageContainer.innerHTML = '';
                    imageContainer.appendChild(img);
                };
                img.onerror = () => {
                    imageContainer.innerHTML = 'üì∑ Camera feed unavailable';
                };
                
                img.src = `${API_BASE}/dashboard/camera/${cameraId}/image?t=${Date.now()}`;
                
            } catch (error) {
                console.error(`Failed to load image for camera ${cameraId}:`, error);
                document.getElementById(`image-${cameraId}`).innerHTML = 'üì∑ Image load failed';
            }
        }

        function initializeMap() {
            if (!mapData || map) return;

            // Initialize Leaflet map
            map = L.map('map').setView([mapData.center.lat, mapData.center.lng], 13);

            // Add OpenStreetMap tiles
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);

            // Add zones to map
            mapData.zones.forEach(zone => {
                // Add circular zone
                const circle = L.circle([zone.center.lat, zone.center.lng], {
                    color: zone.frequency_color,
                    fillColor: zone.frequency_color,
                    fillOpacity: 0.3,
                    radius: zone.bounds.circle.radius,
                    weight: 3
                }).addTo(map);

                // Add camera marker
                const marker = L.marker([zone.center.lat, zone.center.lng], {
                    title: zone.camera_name
                }).addTo(map);

                // Create enhanced popup content with analysis stats
                const stats = zone.analysis_stats || {};
                const lastAnalyzed = stats.last_analysis_ago || 'Never';
                const todayCount = stats.today_analyses || 0;
                const totalCount = stats.total_analyses || 0;
                const avgPerDay = stats.avg_analyses_per_day || 0;

                const popupContent = `
                    <div style="color: black; font-family: Arial, sans-serif; min-width: 250px;">
                        <h3 style="margin: 0 0 10px 0; color: #333; border-bottom: 1px solid #ddd; padding-bottom: 5px;">${zone.camera_name}</h3>
                        
                        <div style="margin-bottom: 8px;">
                            <strong>üìç Location:</strong> ${zone.neighborhood}<br>
                            <strong>üîÑ Sampling:</strong> ${zone.sampling_frequency_hours.toFixed(1)} hours<br>
                            <strong>üìà Tier:</strong> ${zone.frequency_tier.replace('_', ' ')}<br>
                            <strong>üè∑Ô∏è Classification:</strong> ${zone.zone_classification}
                        </div>

                        <div style="background: #f8f9fa; padding: 8px; border-radius: 4px; margin: 8px 0;">
                            <strong>üìä Analysis Statistics:</strong><br>
                            <strong>Last analyzed:</strong> ${lastAnalyzed}<br>
                            <strong>Today:</strong> ${todayCount} analyses<br>
                            <strong>Total:</strong> ${totalCount} analyses<br>
                            ${avgPerDay > 0 ? `<strong>Average:</strong> ${avgPerDay}/day<br>` : ''}
                        </div>

                        <div style="margin-top: 8px;">
                            ${zone.is_high_risk_zone ? '<div style="color: red; font-weight: bold;">üö® High Risk Zone</div>' : ''}
                            ${zone.is_baseline_camera ? '<div style="color: blue; font-weight: bold;">üìä Baseline Camera</div>' : ''}
                            ${zone.manual_override ? '<div style="color: orange; font-weight: bold;">‚úã Manual Override Active</div>' : ''}
                        </div>
                    </div>
                `;

                circle.bindPopup(popupContent);
                marker.bindPopup(popupContent);
            });

            // Create map legend
            createMapLegend();

            // Fit map to bounds
            const bounds = L.latLngBounds([
                [mapData.bounds.south, mapData.bounds.west],
                [mapData.bounds.north, mapData.bounds.east]
            ]);
            map.fitBounds(bounds, { padding: [20, 20] });
        }

        function createMapLegend() {
            const legendContainer = document.getElementById('map-legend');
            
            const frequencyTiers = {
                'critical_continuous': { color: '#ff0000', label: 'Critical (‚â§1h)' },
                'hourly': { color: '#ff4500', label: 'Hourly (1-2h)' },
                'bi_hourly': { color: '#ff8c00', label: 'Bi-hourly (2-4h)' },
                'four_hourly': { color: '#ffd700', label: 'Four-hourly (4-8h)' },
                'eight_hourly': { color: '#adff2f', label: 'Eight-hourly (8-16h)' },
                'daily': { color: '#32cd32', label: 'Daily (16-48h)' },
                'low_frequency': { color: '#228b22', label: 'Low frequency (>48h)' }
            };

            legendContainer.innerHTML = '<h4 style="margin: 0 0 10px 0; color: white;">Sampling Frequency</h4>';
            
            Object.entries(frequencyTiers).forEach(([tier, info]) => {
                const legendItem = document.createElement('div');
                legendItem.style.cssText = 'display: flex; align-items: center; gap: 8px; margin-bottom: 5px;';
                legendItem.innerHTML = `
                    <div style="width: 16px; height: 16px; background-color: ${info.color}; border-radius: 50%; border: 2px solid white;"></div>
                    <span style="color: white; font-size: 0.8rem;">${info.label}</span>
                `;
                legendContainer.appendChild(legendItem);
            });
        }

        async function updateCameraFrequency(cameraId) {
            try {
                const frequencyInput = document.getElementById(`freq-${cameraId}`);
                const newFrequency = parseFloat(frequencyInput.value);

                if (newFrequency < 0.5 || newFrequency > 96) {
                    alert('Frequency must be between 0.5 and 96 hours');
                    return;
                }

                const reason = prompt('Reason for manual adjustment (optional):') || 'Manual dashboard adjustment';

                const response = await fetch(`${API_BASE}/dashboard/camera/${cameraId}/frequency`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        new_frequency_hours: newFrequency,
                        reason: reason,
                        override_adaptive: true
                    })
                });

                const result = await response.json();

                if (result.success) {
                    alert(`‚úÖ Frequency updated: ${cameraId} ‚Üí ${newFrequency}h`);
                    loadDashboardData(); // Refresh data
                } else {
                    alert(`‚ùå Update failed: ${result.error}`);
                }

            } catch (error) {
                console.error('Update error:', error);
                alert(`‚ùå Update failed: ${error.message}`);
            }
        }

        async function resetCameraToAdaptive(cameraId) {
            try {
                if (!confirm(`Reset camera ${cameraId} to adaptive mode?`)) {
                    return;
                }

                const response = await fetch(`${API_BASE}/dashboard/camera/${cameraId}/reset-adaptive`, {
                    method: 'POST'
                });

                const result = await response.json();

                if (result.success) {
                    alert(`‚úÖ Camera ${cameraId} reset to adaptive mode`);
                    loadDashboardData(); // Refresh data
                } else {
                    alert(`‚ùå Reset failed: ${result.error}`);
                }

            } catch (error) {
                console.error('Reset error:', error);
                alert(`‚ùå Reset failed: ${error.message}`);
            }
        }

        // Auto-refresh images every 30 seconds
        setInterval(() => {
            if (currentView === 'camera-list' && dashboardData) {
                dashboardData.camera_zones.forEach(camera => {
                    loadCameraImage(camera.camera_id);
                });
            }
        }, 30000);
    </script>
</body>
</html> 