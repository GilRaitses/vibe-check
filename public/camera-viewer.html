<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>NYC Camera Viewer - Vibecheck</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
  <style>
    body { margin: 0; font-family: Arial, sans-serif; background: #101418; color: #f1f1f1; }
    header { padding: 1rem 2rem; background: #1c2025; box-shadow: 0 2px 4px rgba(0,0,0,0.6); }
    header h1 { margin: 0; font-size: 1.4rem; }
    #viewer-container { display: flex; flex-direction: row; height: calc(100vh - 64px); }
    #live-feed { flex: 1 1 60%; display: flex; align-items: center; justify-content: center; background:#000; position: relative; }
    #live-feed img { max-width: 100%; max-height: 100%; }
    #analysis-panel { flex: 1 1 40%; overflow-y: auto; padding: 1.5rem; background:#14181d; }
    #analysis-panel h2 { margin-top: 0; }
    .analysis-item { margin-bottom: 0.5rem; }
    .btn-group { margin-top: 1rem; display: flex; gap: 1rem; }
    .btn { padding: 0.6rem 1rem; border: none; border-radius: 4px; background: #2979ff; color: #fff; cursor:pointer; text-decoration: none; font-size:0.9rem; }
    .btn:hover { background:#1565c0; }
    #status { position: absolute; top: 8px; left: 8px; background: rgba(0,0,0,0.6); padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; }
  </style>
</head>
<body>
  <header>
    <h1>NYC Traffic Camera Viewer</h1>
  </header>

  <div id="viewer-container">
    <div id="live-feed">
      <span id="status">Loading...</span>
      <img id="camera-img" alt="Live camera feed" />
    </div>
    <aside id="analysis-panel">
      <h2 id="camera-title">Camera Details</h2>
      <div id="camera-meta"></div>
      <h3>Latest Analysis</h3>
      <div id="analysis-results"></div>
      <div class="btn-group">
        <a id="firestore-link" class="btn" target="_blank">View in Firestore</a>
        <a id="bigquery-link" class="btn" target="_blank">View in BigQuery</a>
      </div>
    </aside>
  </div>

  <script>
    const params = new URLSearchParams(window.location.search);
    const cameraId = params.get('camera');
    const zoneId = params.get('zone');
    if (!cameraId) {
      alert('Missing ?camera= parameter');
    }

    const cameraImg = document.getElementById('camera-img');
    const analysisResultsDiv = document.getElementById('analysis-results');
    const cameraMetaDiv = document.getElementById('camera-meta');
    const statusSpan = document.getElementById('status');

    function updateStatus(text) {
      statusSpan.textContent = text;
    }

    async function fetchAndUpdate() {
      try {
        updateStatus('Fetching analysis...');
        const res = await fetch(`/api/monitoring/camera-image/${cameraId}`);
        if (!res.ok) throw new Error('Analysis request failed');
        const data = await res.json();

        if (!data.success) throw new Error('Analysis failed');

        const nycUuid = data.debug_info?.nyc_uuid;
        if (nycUuid) {
          cameraImg.src = `https://webcams.nyctmc.org/api/cameras/${nycUuid}/image?ts=${Date.now()}`;
        }

        // Populate meta info using response or fallback values
        const metaHtml = `
          <p><strong>Camera ID:</strong> ${cameraId}</p>
          <p><strong>Zone ID:</strong> ${zoneId || data.zone_id || 'Unknown'}</p>
          <p><strong>Borough:</strong> ${data.analysis_results?.borough || 'N/A'}</p>
        `;
        cameraMetaDiv.innerHTML = metaHtml;

        // Show analysis numeric values
        const analysis = data.analysis_results?.cloud_vision_data || data.analysis_results?.cloudVisionData || {};
        let analysisHtml = '';
        for (const [key, value] of Object.entries(analysis)) {
          analysisHtml += `<div class="analysis-item"><strong>${key.replace(/_/g,' ')}:</strong> ${value}</div>`;
        }
        analysisResultsDiv.innerHTML = analysisHtml || '<p>No analysis data yet.</p>';

        // Update external links
        document.getElementById('firestore-link').href = `https://console.firebase.google.com/project/vibe-check-463816/firestore/data/~2Fanalyses~2Fcamera_id~3D${cameraId}`;
        document.getElementById('bigquery-link').href = `https://console.cloud.google.com/bigquery?project=vibe-check-463816&ws=!dataset=${encodeURIComponent('vibecheck_analytics')};table=${encodeURIComponent('zone_analyses')}`;

        updateStatus('Updated: ' + new Date().toLocaleTimeString());
      } catch (err) {
        console.error(err);
        updateStatus('Error fetching analysis');
      }
    }

    // Initial load
    fetchAndUpdate();
    // Poll every 30 seconds
    setInterval(fetchAndUpdate, 30000);
  </script>
</body>
</html> 