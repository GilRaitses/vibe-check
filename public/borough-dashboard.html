<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NYC Borough Camera Zone Dashboard</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0a0a0a;
            color: #ffffff;
            overflow: hidden;
        }

        .dashboard-container {
            display: flex;
            height: 100vh;
        }

        .sidebar {
            width: 300px;
            background: #1a1a1a;
            border-right: 1px solid #333;
            padding: 20px;
            overflow-y: auto;
        }

        .sidebar h1 {
            font-size: 24px;
            margin-bottom: 20px;
            color: #fff;
        }

        .borough-selector {
            margin-bottom: 30px;
        }

        .borough-btn {
            display: block;
            width: 100%;
            padding: 12px 16px;
            margin-bottom: 8px;
            background: #2a2a2a;
            color: #fff;
            border: 1px solid #444;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
            font-size: 14px;
        }

        .borough-btn:hover {
            background: #3a3a3a;
            border-color: #666;
        }

        .borough-btn.active {
            background: #0066cc;
            border-color: #0066cc;
        }

        .stats-panel {
            background: #2a2a2a;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 20px;
        }

        .stats-panel h3 {
            font-size: 16px;
            margin-bottom: 12px;
            color: #0066cc;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .stat-value {
            color: #4CAF50;
            font-weight: 600;
        }

        .map-container {
            flex: 1;
            position: relative;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        .camera-hover-popup {
            position: absolute;
            background: rgba(0, 0, 0, 0.95);
            border: 1px solid #333;
            border-radius: 8px;
            padding: 16px;
            min-width: 300px;
            max-width: 400px;
            z-index: 1000;
            pointer-events: none;
            display: none;
            backdrop-filter: blur(10px);
        }

        .popup-header {
            font-size: 16px;
            font-weight: 600;
            color: #0066cc;
            margin-bottom: 8px;
        }

        .popup-image {
            width: 100%;
            height: 120px;
            object-fit: cover;
            border-radius: 4px;
            margin-bottom: 12px;
            background: #333;
        }

        .popup-metadata {
            font-size: 12px;
            line-height: 1.4;
        }

        .popup-metadata .item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
        }

        .popup-metadata .label {
            color: #aaa;
        }

        .popup-metadata .value {
            color: #fff;
            font-weight: 500;
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            font-size: 18px;
            color: #666;
        }

        .zoom-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }

        .zoom-btn {
            display: block;
            width: 40px;
            height: 40px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            border: 1px solid #333;
            border-radius: 4px;
            cursor: pointer;
            margin-bottom: 4px;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .zoom-btn:hover {
            background: rgba(0, 0, 0, 0.9);
        }

        .legend {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.8);
            padding: 12px;
            border-radius: 8px;
            font-size: 12px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 4px;
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 2px;
            margin-right: 8px;
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <div class="sidebar">
            <h1>üóΩ NYC Camera Zones</h1>
            
            <div class="borough-selector">
                <button class="borough-btn active" data-borough="all">üåç All Boroughs</button>
                <button class="borough-btn" data-borough="Manhattan">üèôÔ∏è Manhattan</button>
                <button class="borough-btn" data-borough="Brooklyn">üåâ Brooklyn</button>
                <button class="borough-btn" data-borough="Queens">‚úàÔ∏è Queens</button>
                <button class="borough-btn" data-borough="Bronx">üèüÔ∏è Bronx</button>
                <button class="borough-btn" data-borough="Staten Island">‚õ¥Ô∏è Staten Island</button>
            </div>

            <div class="stats-panel" id="stats-panel">
                <h3>üìä Current View</h3>
                <div class="stat-item">
                    <span>Camera Zones:</span>
                    <span class="stat-value" id="zone-count">940</span>
                </div>
                <div class="stat-item">
                    <span>Total Area:</span>
                    <span class="stat-value" id="total-area">3626 km¬≤</span>
                </div>
                <div class="stat-item">
                    <span>Avg Zone Size:</span>
                    <span class="stat-value" id="avg-size">3.9 km¬≤</span>
                </div>
                <div class="stat-item">
                    <span>Border Zones:</span>
                    <span class="stat-value" id="border-count">8.2 avg vertices</span>
                </div>
            </div>

            <div class="stats-panel">
                <h3>üéØ Zone Density</h3>
                <div class="stat-item">
                    <span>High Density:</span>
                    <span class="stat-value" id="high-density">300 zones</span>
                </div>
                <div class="stat-item">
                    <span>Medium Density:</span>
                    <span class="stat-value" id="medium-density">165 zones</span>
                </div>
                <div class="stat-item">
                    <span>Low Density:</span>
                    <span class="stat-value" id="low-density">92 zones</span>
                </div>
            </div>

            <div class="stats-panel">
                <h3>üïí Last Updated</h3>
                <div class="stat-item">
                    <span>Data:</span>
                    <span class="stat-value" id="last-updated">Just now</span>
                </div>
                <div class="stat-item">
                    <span>Images:</span>
                    <span class="stat-value">Live feed</span>
                </div>
            </div>
        </div>

        <div class="map-container">
            <div id="map" class="loading">Loading camera zones...</div>
            
            <div class="zoom-controls">
                <button class="zoom-btn" onclick="map.zoomIn()">+</button>
                <button class="zoom-btn" onclick="map.zoomOut()">‚àí</button>
            </div>

            <div class="legend">
                <div class="legend-item">
                    <div class="legend-color" style="background: #ff4444;"></div>
                    <span>High Density</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #ffaa00;"></div>
                    <span>Medium Density</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #44ff44;"></div>
                    <span>Low Density</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #4444ff;"></div>
                    <span>Border Zone</span>
                </div>
            </div>
        </div>
    </div>

    <div class="camera-hover-popup" id="hover-popup">
        <div class="popup-header" id="popup-title">Camera Loading...</div>
        <img class="popup-image" id="popup-image" src="" alt="Camera View" />
        <div class="popup-metadata" id="popup-metadata">
            <div class="item">
                <span class="label">Area:</span>
                <span class="value" id="popup-area">-</span>
            </div>
            <div class="item">
                <span class="label">Max Reach:</span>
                <span class="value" id="popup-reach">-</span>
            </div>
            <div class="item">
                <span class="label">Density Rank:</span>
                <span class="value" id="popup-rank">-</span>
            </div>
            <div class="item">
                <span class="label">Coordinates:</span>
                <span class="value" id="popup-coords">-</span>
            </div>
            <div class="item">
                <span class="label">Street Limits:</span>
                <span class="value" id="popup-streets">-</span>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        let map, cameraZones = [], currentBorough = 'all';
        let zoneLayer = null;
        const hoverPopup = document.getElementById('hover-popup');
        let hoverInterval = null;
        let currentHoverZone = null;

        // Initialize map
        function initMap() {
            map = L.map('map').setView([40.7589, -73.9851], 11);
            
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '¬©OpenStreetMap, ¬©CartoDB',
                subdomains: 'abcd',
                maxZoom: 20
            }).addTo(map);
        }

        // Load camera zone data
        async function loadCameraZones() {
            try {
                // Load from real camera zones data file
                const response = await fetch('/data/camera-zones-final.json');
                const cameraZonesData = await response.json();
                
                if (Array.isArray(cameraZonesData)) {
                    cameraZones = cameraZonesData;
                } else {
                    // If it's an object, convert to array
                    cameraZones = Object.values(cameraZonesData);
                }
                
                console.log(`Loaded ${cameraZones.length} real camera zones from camera-zones-final.json`);
                renderZones();
            } catch (error) {
                console.error('Error loading camera zones from data file:', error);
                
                // Try alternative: load from nyc-cameras-full.json
                try {
                    const response = await fetch('/data/nyc-cameras-full.json');
                    const camerasData = await response.json();
                    
                    // Convert camera data to zone format
                    cameraZones = camerasData.map(camera => ({
                        handle: camera.id,
                        name: camera.name,
                        coordinates: [camera.longitude, camera.latitude],
                        area: camera.area,
                        image_url: camera.imageUrl,
                        isOnline: camera.isOnline
                    }));
                    
                    console.log(`Loaded ${cameraZones.length} cameras from nyc-cameras-full.json`);
                    renderZones();
                    
                } catch (fallbackError) {
                    console.error('Failed to load any camera data:', fallbackError);
                    document.getElementById('map').innerHTML = `
                        <div style="text-align: center; color: red; padding: 2rem;">
                            <h3>Unable to Load Camera Data</h3>
                            <p>Could not load from camera-zones-final.json or nyc-cameras-full.json</p>
                            <p>Error: ${fallbackError.message}</p>
                        </div>
                    `;
                }
            }
        }

        // Get zone color based on density and type
        function getZoneColor(zone) {
            // Simple coloring based on zone area (smaller = higher density)
            if (zone.zone_area_sqm < 1000000) return '#ff4444'; // High density (< 1 km¬≤)
            if (zone.zone_area_sqm < 10000000) return '#ffaa00'; // Medium density (< 10 km¬≤)
            return '#44ff44'; // Low density (> 10 km¬≤)
        }

        // Render camera zones on map
        function renderZones() {
            if (zoneLayer) {
                map.removeLayer(zoneLayer);
            }

            const filteredZones = currentBorough === 'all' 
                ? cameraZones 
                : cameraZones.filter(zone => zone.borough === currentBorough);

            console.log(`Rendering ${filteredZones.length} zones for ${currentBorough}`);
            zoneLayer = L.layerGroup();

            let validZones = 0;
            filteredZones.forEach((zone, index) => {
                // Check if we have valid Voronoi polygon data
                if (!zone.voronoi_polygon || !zone.voronoi_polygon.coordinates || !zone.voronoi_polygon.coordinates[0]) {
                    console.warn(`Zone ${zone.handle} missing voronoi polygon data`);
                    return;
                }

                try {
                    // Convert coordinates from [lng, lat] to [lat, lng] for Leaflet
                    const coords = zone.voronoi_polygon.coordinates[0].map(coord => [coord[1], coord[0]]);
                    
                    if (index === 0) {
                        console.log(`Sample polygon coords for ${zone.handle}:`, coords.slice(0, 3));
                    }
                    
                    const polygon = L.polygon(coords, {
                        color: getZoneColor(zone),
                        weight: 1,
                        opacity: 0.8,
                        fillColor: getZoneColor(zone),
                        fillOpacity: 0.3
                    });

                    polygon.zoneData = zone;

                    polygon.on('mouseover', (e) => showHoverPopup(e, zone));
                    polygon.on('mouseout', hideHoverPopup);
                    polygon.on('mousemove', updateHoverPosition);

                    zoneLayer.addLayer(polygon);
                    validZones++;
                } catch (error) {
                    console.error(`Error rendering zone ${zone.handle}:`, error);
                }
            });

            console.log(`Successfully rendered ${validZones} valid zones`);
            zoneLayer.addTo(map);
            updateStats(filteredZones);
            
            // Fit map to zones
            if (filteredZones.length > 0) {
                const group = new L.featureGroup(zoneLayer.getLayers());
                map.fitBounds(group.getBounds().pad(0.1));
            }
        }

        // Show hover popup with camera info
        function showHoverPopup(e, zone) {
            const popup = document.getElementById('hover-popup');
            currentHoverZone = zone;
            
            // Update popup content
            document.getElementById('popup-title').textContent = `${zone.handle} - ${zone.name}`;
            document.getElementById('popup-area').textContent = `${(zone.zone_area_sqm / 1000000).toFixed(3)} km¬≤`;
            document.getElementById('popup-reach').textContent = `${zone.vertices_count || 0} vertices`;
            document.getElementById('popup-rank').textContent = `#${zone.integer_id}/940`;
            document.getElementById('popup-coords').textContent = `${zone.coordinates[0].toFixed(4)}, ${zone.coordinates[1].toFixed(4)}`;
            
            // Polygon complexity
            document.getElementById('popup-streets').textContent = `${zone.vertices_count || 0} sides`;
            
            // Load initial camera image
            loadCameraImage(zone);
            
            // Start live feed updates every 2 seconds
            if (hoverInterval) clearInterval(hoverInterval);
            hoverInterval = setInterval(() => {
                if (currentHoverZone) {
                    loadCameraImage(currentHoverZone, true); // true = live update
                }
            }, 2000);

            popup.style.display = 'block';
            updateHoverPosition(e);
        }

        // Load camera image (separated function for reuse)
        function loadCameraImage(zone, isLiveUpdate = false) {
            const img = document.getElementById('popup-image');
            
            // Extract camera ID from TMC URL
            function extractCameraId(imageUrl) {
                if (!imageUrl) return null;
                const match = imageUrl.match(/cameras\/([^\/]+)\/image/);
                return match ? match[1] : null;
            }
            
            const cameraId = extractCameraId(zone.image_url);
            
            if (cameraId) {
                // Use the production API to get the camera image
                const proxyUrl = `https://us-central1-vibe-check-463816.cloudfunctions.net/api/monitoring/camera-image/${cameraId}`;
                const timestamp = Date.now();
                
                img.onerror = function() {
                    if (!isLiveUpdate) { // Only show fallback on initial load
                        console.warn(`Failed to load camera image for ${zone.handle}`);
                        // Fallback to canvas-generated info
                        const canvas = document.createElement('canvas');
                        canvas.width = 300;
                        canvas.height = 120;
                        const ctx = canvas.getContext('2d');
                        
                        ctx.fillStyle = '#333';
                        ctx.fillRect(0, 0, 300, 120);
                        
                        ctx.fillStyle = '#fff';
                        ctx.font = 'bold 16px Arial';
                        ctx.textAlign = 'center';
                        ctx.fillText(zone.handle, 150, 40);
                        
                        ctx.fillStyle = '#ff4444';
                        ctx.font = '12px Arial';
                        ctx.fillText('Camera Offline', 150, 60);
                        
                        ctx.fillStyle = '#aaa';
                        ctx.font = '10px Arial';
                        ctx.fillText(`${(zone.zone_area_sqm / 1000000).toFixed(2)} km¬≤ ‚Ä¢ ${zone.vertices_count} vertices`, 150, 80);
                        
                        this.src = canvas.toDataURL();
                    }
                };
                
                if (isLiveUpdate) {
                    console.log(`üî¥ LIVE: Refreshing camera ${zone.handle}`);
                } else {
                    console.log(`Loading camera image for ${zone.handle} via proxy: ${proxyUrl}`);
                }
                
                img.src = `${proxyUrl}?t=${timestamp}`; // Fresh timestamp for live updates
                
            } else {
                // Fallback for zones without valid camera URLs
                const canvas = document.createElement('canvas');
                canvas.width = 300;
                canvas.height = 120;
                const ctx = canvas.getContext('2d');
                
                ctx.fillStyle = '#444';
                ctx.fillRect(0, 0, 300, 120);
                
                ctx.fillStyle = '#fff';
                ctx.font = 'bold 16px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(zone.handle, 150, 40);
                
                ctx.fillStyle = '#0066cc';
                ctx.font = '12px Arial';
                ctx.fillText(zone.name, 150, 60);
                
                ctx.fillStyle = '#4CAF50';
                ctx.font = '10px Arial';
                ctx.fillText(`${(zone.zone_area_sqm / 1000000).toFixed(2)} km¬≤ ‚Ä¢ ${zone.vertices_count} vertices`, 150, 80);
                
                ctx.fillStyle = '#aaa';
                ctx.font = '9px Arial';
                ctx.fillText(`${zone.coordinates[0].toFixed(4)}, ${zone.coordinates[1].toFixed(4)}`, 150, 100);
                
                img.src = canvas.toDataURL();
            }
            
            img.alt = `Camera view for ${zone.handle}`;
        }

        // Hide hover popup
        function hideHoverPopup() {
            document.getElementById('hover-popup').style.display = 'none';
            currentHoverZone = null;
            
            // Stop live feed updates
            if (hoverInterval) {
                clearInterval(hoverInterval);
                hoverInterval = null;
                console.log('üî¥ LIVE: Stopped live feed');
            }
        }

        // Update hover popup position
        function updateHoverPosition(e) {
            const popup = document.getElementById('hover-popup');
            const rect = map.getContainer().getBoundingClientRect();
            
            popup.style.left = (e.containerPoint.x + rect.left + 10) + 'px';
            popup.style.top = (e.containerPoint.y + rect.top - 10) + 'px';
        }

        // Update statistics panel
        function updateStats(zones) {
            const totalArea = zones.reduce((sum, z) => sum + z.zone_area_sqm, 0) / 1000000;
            const avgSize = totalArea / zones.length;
            const avgVertices = zones.reduce((sum, z) => sum + (z.vertices_count || 0), 0) / zones.length;
            
            document.getElementById('zone-count').textContent = zones.length;
            document.getElementById('total-area').textContent = totalArea.toFixed(0) + ' km¬≤';
            document.getElementById('avg-size').textContent = avgSize.toFixed(1) + ' km¬≤';
            document.getElementById('border-count').textContent = avgVertices.toFixed(1) + ' avg vertices';

            // Area-based density breakdown
            const highDensity = zones.filter(z => z.zone_area_sqm < 1000000).length; // < 1 km¬≤
            const lowDensity = zones.filter(z => z.zone_area_sqm > 10000000).length; // > 10 km¬≤
            const mediumDensity = zones.length - highDensity - lowDensity;

            document.getElementById('high-density').textContent = highDensity + ' zones';
            document.getElementById('medium-density').textContent = mediumDensity + ' zones';
            document.getElementById('low-density').textContent = lowDensity + ' zones';
        }

        // Borough selection
        document.querySelectorAll('.borough-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                document.querySelectorAll('.borough-btn').forEach(b => b.classList.remove('active'));
                e.target.classList.add('active');
                currentBorough = e.target.dataset.borough;
                renderZones();
            });
        });

        // Update last updated time
        function updateTimestamp() {
            const now = new Date();
            document.getElementById('last-updated').textContent = now.toLocaleTimeString();
        }

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', () => {
            initMap();
            loadCameraZones();
            updateTimestamp();
            setInterval(updateTimestamp, 30000); // Update every 30 seconds
        });
    </script>
</body>
</html> 