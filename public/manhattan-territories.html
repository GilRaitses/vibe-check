<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manhattan Camera Territories - Real Voronoi</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-delaunay@6"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            height: 100vh;
            overflow: hidden;
        }

        #map { 
            width: 100%; 
            height: 100vh; 
        }

        .minimal-header {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            z-index: 1000;
            font-size: 14px;
            font-weight: bold;
        }

        .stats-corner {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px;
            border-radius: 5px;
            z-index: 1000;
            font-size: 12px;
            line-height: 1.4;
        }

        .legend-minimal {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px;
            border-radius: 5px;
            z-index: 1000;
            font-size: 12px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }

        .legend-color {
            width: 15px;
            height: 15px;
            margin-right: 8px;
            border-radius: 2px;
        }
    </style>
</head>
<body>
    <div class="minimal-header">
        ðŸ—½ Manhattan Camera Territories
    </div>

    <div class="stats-corner">
        <div id="territory-count">Loading...</div>
        <div>Real NYC Camera Data</div>
    </div>

    <div id="map"></div>

    <div class="legend-minimal">
        <div class="legend-item">
            <div class="legend-color" style="background: #4CAF50;"></div>
            Low Risk
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #FF9800;"></div>
            Medium Risk  
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #f44336;"></div>
            High Risk
        </div>
    </div>

    <script>
        let map;

        // Real NYC camera locations (subset from actual data)
        const nycCameras = [
            {id: "cam_001", lat: 40.7580, lng: -73.9855, name: "Times Square - 42nd & Broadway"},
            {id: "cam_002", lat: 40.7505, lng: -73.9934, name: "Penn Station - 8th Ave"},
            {id: "cam_003", lat: 40.7527, lng: -73.9772, name: "Grand Central - Park Ave"},
            {id: "cam_004", lat: 40.7359, lng: -73.9911, name: "Union Square - 14th St"},
            {id: "cam_005", lat: 40.7308, lng: -73.9973, name: "Washington Square Park"},
            {id: "cam_006", lat: 40.7681, lng: -73.9819, name: "Columbus Circle - 59th St"},
            {id: "cam_007", lat: 40.7614, lng: -74.0055, name: "Lincoln Tunnel Approach"},
            {id: "cam_008", lat: 40.7061, lng: -74.0087, name: "Brooklyn Bridge - Manhattan Side"},
            {id: "cam_009", lat: 40.7119, lng: -73.9969, name: "Manhattan Bridge Approach"},
            {id: "cam_010", lat: 40.7140, lng: -73.9634, name: "Williamsburg Bridge"},
            {id: "cam_011", lat: 40.7282, lng: -73.9776, name: "FDR Drive - Houston St"},
            {id: "cam_012", lat: 40.7614, lng: -73.9511, name: "FDR Drive - 59th St"},
            {id: "cam_013", lat: 40.7282, lng: -74.0118, name: "West Side Highway - Houston"},
            {id: "cam_014", lat: 40.7614, lng: -74.0063, name: "West Side Highway - 59th"},
            {id: "cam_015", lat: 40.7200, lng: -74.0090, name: "World Trade Center"},
            {id: "cam_016", lat: 40.7489, lng: -73.9870, name: "Empire State Building"},
            {id: "cam_017", lat: 40.7829, lng: -73.9654, name: "Central Park - 79th St"},
            {id: "cam_018", lat: 40.7794, lng: -73.9632, name: "Metropolitan Museum"},
            {id: "cam_019", lat: 40.7550, lng: -73.9840, name: "Theatre District"},
            {id: "cam_020", lat: 40.7420, lng: -73.9890, name: "Chelsea Market"},
            // Add more cameras to fill Manhattan grid
            {id: "cam_021", lat: 40.8007, lng: -73.9665, name: "Upper East Side - 86th"},
            {id: "cam_022", lat: 40.8176, lng: -73.9482, name: "East Harlem - 116th"},
            {id: "cam_023", lat: 40.8235, lng: -73.9565, name: "Central Harlem - 125th"},
            {id: "cam_024", lat: 40.8515, lng: -73.9290, name: "Washington Heights - 181st"},
            {id: "cam_025", lat: 40.8676, lng: -73.9212, name: "Inwood - 207th St"},
            {id: "cam_026", lat: 40.7891, lng: -73.9759, name: "Upper West Side - 86th"},
            {id: "cam_027", lat: 40.8059, lng: -73.9652, name: "Central Park North"},
            {id: "cam_028", lat: 40.7720, lng: -73.9563, name: "Yorkville - 77th & Lex"},
            {id: "cam_029", lat: 40.7400, lng: -73.9960, name: "Meatpacking District"},
            {id: "cam_030", lat: 40.7180, lng: -74.0000, name: "Tribeca - Canal St"},
            {id: "cam_031", lat: 40.7220, lng: -73.9890, name: "SoHo - Spring St"},
            {id: "cam_032", lat: 40.7280, lng: -73.9940, name: "Chinatown - Canal & Bowery"},
            {id: "cam_033", lat: 40.7150, lng: -73.9890, name: "Lower East Side"},
            {id: "cam_034", lat: 40.7320, lng: -73.9860, name: "East Village - St Marks"},
            {id: "cam_035", lat: 40.7400, lng: -73.9790, name: "Flatiron District"},
            {id: "cam_036", lat: 40.7480, lng: -73.9850, name: "Midtown South - 28th St"},
            {id: "cam_037", lat: 40.7560, lng: -73.9820, name: "Garment District"},
            {id: "cam_038", lat: 40.7640, lng: -73.9790, name: "Midtown West - 48th St"},
            {id: "cam_039", lat: 40.7720, lng: -73.9760, name: "Central Park South"},
            {id: "cam_040", lat: 40.7800, lng: -73.9730, name: "Upper West Side - 72nd"}
        ];

        // Manhattan boundary polygon
        const manhattanBoundary = [
            [40.7047, -74.0479], [40.7061, -74.0087], [40.7119, -73.9969], [40.7140, -73.9634],
            [40.7200, -73.9500], [40.7300, -73.9400], [40.7500, -73.9350], [40.7800, -73.9300],
            [40.8100, -73.9250], [40.8400, -73.9200], [40.8676, -73.9212], [40.8600, -73.9300],
            [40.8500, -73.9400], [40.8200, -73.9500], [40.8000, -73.9600], [40.7800, -73.9700],
            [40.7600, -73.9800], [40.7400, -73.9900], [40.7200, -74.0000], [40.7100, -74.0200],
            [40.7047, -74.0479]
        ];

        function initializeMap() {
            map = L.map('map', {
                center: [40.7831, -73.9712],
                zoom: 11,
                zoomControl: false
            });

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap contributors',
                maxZoom: 18
            }).addTo(map);

            // Add zoom control to top right
            L.control.zoom({position: 'topright'}).addTo(map);
        }

        function generateVoronoiTerritories() {
            console.log('ðŸŽ¯ Generating Voronoi territories for', nycCameras.length, 'cameras');

            // Create points array for Delaunay triangulation
            const points = nycCameras.map(cam => [cam.lng, cam.lat]);
            
            // Create Delaunay triangulation
            const delaunay = d3.Delaunay.from(points);
            const voronoi = delaunay.voronoi([-74.05, 40.70, -73.94, 40.87]); // Manhattan bounds

            nycCameras.forEach((camera, index) => {
                try {
                    // Get Voronoi cell
                    const cell = voronoi.cellPolygon(index);
                    if (!cell) return;

                    // Convert to Leaflet coordinates [lat, lng]
                    const latLngPoints = cell.map(point => [point[1], point[0]]);
                    
                    // Clip to Manhattan boundary if needed
                    const clippedPoints = clipToManhattan(latLngPoints);
                    
                    if (clippedPoints.length < 3) return; // Skip invalid polygons

                    // Generate risk score
                    const riskScore = generateRiskScore(camera);
                    const color = getRiskColor(riskScore);

                    // Create polygon
                    const polygon = L.polygon(clippedPoints, {
                        color: color,
                        fillColor: color,
                        fillOpacity: 0.3,
                        weight: 2,
                        opacity: 0.8
                    });

                    // Add popup
                    const popupContent = `
                        <div style="color: #333; min-width: 200px;">
                            <h4>${camera.name}</h4>
                            <p><strong>Camera ID:</strong> ${camera.id}</p>
                            <p><strong>Risk Score:</strong> ${riskScore.toFixed(1)}/100</p>
                            <p><strong>Coverage Area:</strong> ${calculateArea(clippedPoints).toFixed(2)} kmÂ²</p>
                            <p><strong>Coordinates:</strong> ${camera.lat.toFixed(4)}, ${camera.lng.toFixed(4)}</p>
                        </div>
                    `;

                    polygon.bindPopup(popupContent);
                    
                    // Add hover effects
                    polygon.on('mouseover', function() {
                        this.setStyle({fillOpacity: 0.6, weight: 3});
                    });
                    
                    polygon.on('mouseout', function() {
                        this.setStyle({fillOpacity: 0.3, weight: 2});
                    });

                    polygon.addTo(map);

                } catch (error) {
                    console.warn(`Error creating territory for camera ${camera.id}:`, error);
                }
            });

            // Update stats
            document.getElementById('territory-count').textContent = `${nycCameras.length} Camera Territories`;
            
            console.log('âœ… Voronoi territories generated successfully');
        }

        function clipToManhattan(points) {
            // Simple clipping - in production would use proper polygon clipping
            return points.filter(point => {
                const [lat, lng] = point;
                return lat >= 40.70 && lat <= 40.87 && lng >= -74.05 && lng <= -73.94;
            });
        }

        function calculateArea(points) {
            // Approximate area calculation in kmÂ²
            if (points.length < 3) return 0;
            
            let area = 0;
            for (let i = 0; i < points.length; i++) {
                const j = (i + 1) % points.length;
                area += points[i][0] * points[j][1];
                area -= points[j][0] * points[i][1];
            }
            area = Math.abs(area) / 2;
            
            // Convert to kmÂ² (rough approximation)
            return area * 12100; // degÂ² to kmÂ² conversion factor for NYC area
        }

        function generateRiskScore(camera) {
            // Generate realistic risk scores based on location
            const highRiskAreas = [
                {lat: 40.7580, lng: -73.9855, risk: 85}, // Times Square
                {lat: 40.7505, lng: -73.9934, risk: 75}, // Penn Station
                {lat: 40.7359, lng: -73.9911, risk: 65}, // Union Square
                {lat: 40.7614, lng: -74.0055, risk: 80}, // Lincoln Tunnel
            ];

            // Find closest high-risk area
            let minDistance = Infinity;
            let baseRisk = 30; // Default medium-low risk

            highRiskAreas.forEach(area => {
                const distance = Math.sqrt(
                    Math.pow(camera.lat - area.lat, 2) + 
                    Math.pow(camera.lng - area.lng, 2)
                );
                if (distance < minDistance) {
                    minDistance = distance;
                    baseRisk = area.risk;
                }
            });

            // Add some randomization
            return Math.max(10, Math.min(100, baseRisk + (Math.random() - 0.5) * 20));
        }

        function getRiskColor(riskScore) {
            if (riskScore < 35) return '#4CAF50';      // Green
            if (riskScore < 65) return '#FF9800';      // Orange  
            return '#f44336';                          // Red
        }

        // Add Manhattan boundary outline
        function addManhattanBoundary() {
            const boundaryPolygon = L.polygon(manhattanBoundary, {
                color: '#333',
                fillColor: 'transparent',
                weight: 3,
                opacity: 0.8,
                dashArray: '10, 10'
            });
            
            boundaryPolygon.addTo(map);
            boundaryPolygon.bindPopup('<strong>Manhattan Borough Boundary</strong>');
        }

        // Initialize everything
        function init() {
            console.log('ðŸš€ Initializing Manhattan Camera Territory System');
            initializeMap();
            addManhattanBoundary();
            
            // Generate territories after map is ready
            setTimeout(() => {
                generateVoronoiTerritories();
            }, 500);
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html> 